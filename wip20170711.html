<!-- HTML header for doxygen 1.8.18-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-174219699-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'UA-174219699-1');
</script>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.18"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Developer&#39;s Diary: Parsing SimpleMind XML - Part One</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="myStyle.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="terry_avi.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Developer&#39;s Diary
   </div>
   <div id="projectbrief">Software development, with Terry Ebdon</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.18 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('wip20170711.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Parsing SimpleMind XML - Part One </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md135">The Problems</a></li>
<li class="level1"><a href="#autotoc_md136">The SMMX files</a></li>
<li class="level1"><a href="#autotoc_md137">Parsing the XML</a></li>
<li class="level1"><a href="#autotoc_md138">Related web pages.</a></li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="h20170711"></a><em>Tuesday 11<sup>th</sup> July, 2017</em></p>
<p>SimpleMind is excellent, and inexpensive, mind mapping software. I've used it for many years, and like it a lot. But... I hit a couple of problem with it recently. Not with the software itself, but the way I was using it.</p>
<h1><a class="anchor" id="autotoc_md135"></a>
The Problems</h1>
<ol type="1">
<li>It appeared to be randomly losing images associated with map nodes. I now believe the issue was due to me purging the temp folder while it was running. While investigating the issue I needed to understand how the embedded images were stored, and write a script to check for the issue.</li>
<li>Map topics can be hyperlinked to each other. These links don't have to be in the same mind map. I have hundreds of interlinked mind maps, in a complex folder tree. Moving, or renaming, a mind map can break links. There's no warning when that happens. I needed a way to scan the entire folder tree and find the broken links.</li>
</ol>
<h1><a class="anchor" id="autotoc_md136"></a>
The SMMX files</h1>
<p>SimpleMind files have a .smmx file type. The file is a zip archive containing an XML file and the embedded document images. I've created a test file with five map nodes, two external links and an embedded image. This was copied from a &ldquo;corrupt&rdquo; branch, so will have a problem.</p>
<p>The test Mind Map looks like this:</p>
<div class="image">
<img src="2017-07-11_Image_Test_smmx.png" alt="" width="75%"/>
</div>
 <p>Cracking open the zip file reveals this:</p>
<pre class="fragment">â”œâ”€â”€â”€document
â”‚       mindmap.xml
â”‚
â””â”€â”€â”€images
        db7f9c0c717f68833d76f51e4eeef85df359bba8.png
        hWPR03nipkq5KJPfDTtXIQ.png
</pre><p>The smmx file contains two embedded images, which is one more than you might expect.</p>
<p>A peek at the XML shows it's easy enough to understand. It would be nice if it was indented though. That's a job for the W3C's <a href="http://www.html-tidy.org/">HTML tidy</a> tool:</p>
<div class="fragment"><div class="line">C:\SimpleMindTools&gt;tidy -qe -xml mindmap.xml --output mindmap.tidied.xml</div>
</div><!-- fragment --><p>That, slightly obscure, command will:</p><ul>
<li>Read the input file as well formed xml &ndash; that's the -xml part.</li>
<li>Suppress non-essential output, i.e. operate in 'quiet mode'&ndash; that's the '-q'.</li>
<li>Only show errors &ndash; that's the e in '-qe'.</li>
</ul>
<p>This will show a heap of invalid character warnings. That's fine; the output file is throw-away. I'm just using it to &ldquo;pretty-print&rdquo; the file.</p>
<p>The tidied XML is now nicely indented, making it a lot easier to the see the XML's structure.</p>
<p>From the tidied file you can see this top level structure: <div class="plantumlgraph">
<img src="inline_umlgraph_7.png" />
</div>
 </p>
<p>I've omitted some irrelevant tags from the above diagram, for clarity.</p>
<h1><a class="anchor" id="autotoc_md137"></a>
Parsing the XML</h1>
<p>The example code, SmmxTest.groovy, is available on BitBucket under an Apache 2.0 licence. Line numbers, in the following description, match those in the file on BitBucket.</p>
<p>First I crack open the ZIP file, at line 12, using Java's ZipFile class: </p><div class="fragment"><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="keyword">import</span> groovy.xml.DOMBuilder</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="keyword">import</span> groovy.xml.dom.DOMCategory</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;def zipFile = <span class="keyword">new</span> java.util.zip.ZipFile(<span class="keyword">new</span> File(<span class="stringliteral">&#39;Image Test.smmx&#39;</span>))</div>
</div><!-- fragment --><p> Then iterate through the entries, until the mindmap XML file is found: </p><div class="fragment"><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;zipFile.entries().each {</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;    <span class="keywordflow">if</span> ( it.name == <span class="stringliteral">&quot;document/mindmap.xml&quot;</span> ) {</div>
</div><!-- fragment --><p>Now load the XML into groovy's <a href="http://docs.groovy-lang.org/latest/html/api/groovy/util/XmlParser.html">XmlParser:</a> </p><div class="fragment"><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;        def xml = zipFile.getInputStream( it )</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;        def parser = <span class="keyword">new</span> XmlParser(<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">true</span>)</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;        def simpleMind = parser.parseText(xml.text[41..-1])</div>
</div><!-- fragment --><p> There's a little hack at line 21, notice it's not sending the entire XML string to the <a href="http://docs.groovy-lang.org/latest/html/api/groovy/util/XmlParser.html">XmlParser.</a> That odd looking <span style="white-space:nowrap"> <code>xml.text[41..-1]</code> </span> strips off the first 40 characters. Why? Because that's the XML header and end-of-line line characters.</p>
<div class="image">
<img src="2017-07-11_strip_xml_header.png" alt="" width="50%"/>
</div>
 <dl class="section note"><dt>Note</dt><dd>This is my initial test code, used to understand the XML file. This was written as throw-away code, <em>not</em> production software. Writing this throw-away gave me the information I needed to construct the real software, which I'll show you later.</dd></dl>
<p>At line 24 I check that the name of the top-level element matches the one I expect, based on the output from HTML Tidy. Note the use of an assertion; another indication that this is test software. Production software should anticipate an incorrect file being provided, and behave gracefully.</p>
<div class="fragment"><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;        assert simpleMind.name() == <span class="stringliteral">&quot;simplemind-mindmaps&quot;</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;        def mindmap = simpleMind.mindmap</div>
</div><!-- fragment --><p> At line 29 I display the mind map's title. Then, at lines 30 to 36, the child images are examined. <br  />
</p>
<div class="fragment"><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;        mindmap.with {</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;            println <span class="stringliteral">&quot;*** ${meta.title[0].attributes().text} &lt;&lt;&lt;&quot;</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;            topics[0].each { topic -&gt;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;                println <span class="stringliteral">&quot;${topic.attributes().text} - ${topic.attributes().text}&quot;</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;                topic.children.each { child -&gt;</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;                    child.image.each { img -&gt;</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;                        println <span class="stringliteral">&quot;child image name: ${img.attributes().name}&quot;</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;                    }</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;                }</div>
</div><!-- fragment --><p> Note the Groovy syntax used, which is very similar to XPath.</p>
<h1><a class="anchor" id="autotoc_md138"></a>
Related web pages.</h1>
<ul>
<li><a href="http://docs.groovy-lang.org/latest/html/api/groovy/util/XmlParser.html">XmlParser GroovyDoc</a> &ndash; Apache software Foundation.</li>
</ul>
<p> 
<hr/>
<a class='btn' href='wip20170710.html'>10-JUL-2017 ðŸ‘ˆ</a>
<a class='btn' href='#h20170711'>Top of page</a>
<a class='btn' href='wip20190211.html'>11-FEB-2019</a>
 <span class="copyright">&copy; 2017 <a href="AboutMe.html" title="Terry Ebdon">Terry Ebdon.</a></span><br  />
<p>Find me coding on <a title="terry_ebdon on GitHub"
href="https://github.com/TerryEbdon">GitHub,</a> networking on <a
title="Terry Ebdon on LinkedIn"
href="https://www.linkedin.com/in/talent/">LinkedIn</a>, answering questions on
<a title="terry-ebdon on StackExchange"
href="https://stackexchange.com/users/9183134/terry-ebdon?tab=accounts">
Stack Exchange</a> and hanging out on
<a title="@terry_ebdon" href="https://twitter.com/@terry_ebdon">twitter.</a>
</p>
 </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Sun Aug 9 2020 13:31:39 for Developer&#39;s Diary by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.18 </li>
  </ul>
</div>
</body>
</html>
