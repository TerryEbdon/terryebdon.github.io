<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.18"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Developer&#39;s Diary: 20-Jul-2020 Back to basics</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="myStyle.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="terry_avi.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Developer&#39;s Diary
   </div>
   <div id="projectbrief">Software development, with Terry Ebdon</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.18 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">20-Jul-2020 Back to basics </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#h20200720">Infrastructure</a><ul><li class="level2"><a href="#autotoc_md306">Unit tests</a></li>
<li class="level2"><a href="#autotoc_md307">Test coverage</a></li>
<li class="level2"><a href="#autotoc_md308">Static analysis</a></li>
<li class="level2"><a href="#autotoc_md309">Logging</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="mainpage"></a></p>
<h1><a class="anchor" id="h20200720"></a>
Infrastructure</h1>
<p>I took a step back, to put development infrastructure in place. Every non-trivial app, i.e. anything mre than a quick script, needs:</p>
<ul>
<li>A build file.</li>
<li>Unit tests.</li>
<li>Test coverage reports.</li>
<li>Static analysis.</li>
<li>Logging</li>
</ul>
<p>I started the project with <code>gradle init</code>, so the build files are there along with a template Spock test.</p>
<h2><a class="anchor" id="autotoc_md306"></a>
Unit tests</h2>
<p>Eclipse has been complaining about Spock; I fixed that by switching to <a href="https://junit.org/junit4/">JUnit</a>. I don't object to using Spock, this was just the quickest way of fixing the problem. I checked with the team lead, me, and he was happy with this approach.</p>
<p>Groovy's <a href="https://junit.org/junit4/">JUnit</a> support gives very clean test code, with nice reporting:</p>
<div class="fragment"><div class="line">@groovy.util.logging.Log4j2(<span class="stringliteral">&#39;logger&#39;</span>)</div>
<div class="line"><span class="keyword">class </span>ShootLocationsTest <span class="keyword">extends</span> GroovyTestCase {</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keywordtype">int</span> numLocations = 7;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> testGetDisplayNames() {</div>
<div class="line">    String[] displayNames = <span class="keyword">new</span> ShootLocations().displayNames</div>
<div class="line"> </div>
<div class="line">    assert displayNames.size() == numLocations</div>
<div class="line"> </div>
<div class="line">    String lastDn = <span class="stringliteral">&#39;&#39;</span></div>
<div class="line">    displayNames.each {</div>
<div class="line">      assert it[5..7] == <span class="stringliteral">&#39; * &#39;</span></div>
<div class="line">      assert it &gt; lastDn</div>
<div class="line">      lastDn = it</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><div class="image">
<img src="2020-07-20_junit_test_failed.jpg" alt=""/>
</div>
 <h2><a class="anchor" id="autotoc_md307"></a>
Test coverage</h2>
<p>I first used <a href="https://www.jacoco.org/jacoco/">JaCoCo</a> on my <a href="https://github.com/TerryEbdon/Trk21">Trk21</a> project. I've been very happy with it. It's trivial to configure, just add it as a Gradle plugin:</p>
<div class="fragment"><div class="line">plugins {</div>
<div class="line">  <span class="keywordtype">id</span> <span class="stringliteral">&#39;groovy&#39;</span></div>
<div class="line">  <span class="keywordtype">id</span> <span class="stringliteral">&#39;application&#39;</span>  <span class="comment">// support for building an application.</span></div>
<div class="line">  <span class="keywordtype">id</span> <span class="stringliteral">&#39;jacoco&#39;</span>       <span class="comment">// Instrument build &amp; add coverage reporting tasks</span></div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md308"></a>
Static analysis</h2>
<p>CodeNarc is my "go to" tool for this. Enabling it in Gradle is trivial, but I always end up fiddling with the configuration to solve minor problems.</p>
<p>I enabled <a href="www.codenarc.org">CodeNarc</a> and copied the <a href="https://github.com/TerryEbdon/Trk21/blob/master/config/codenarc/codenarc.groovy">Trk21 configuration file</a> into NewPostProd.</p>
<div class="fragment"><div class="line">plugins {</div>
<div class="line">  <span class="keywordtype">id</span> <span class="stringliteral">&#39;groovy&#39;</span></div>
<div class="line">  <span class="keywordtype">id</span> <span class="stringliteral">&#39;codenarc&#39;</span>     <span class="comment">// Static analysis &amp; reporting.</span></div>
<div class="line">  <span class="keywordtype">id</span> <span class="stringliteral">&#39;application&#39;</span>  <span class="comment">// support for building an application.</span></div>
<div class="line">  <span class="keywordtype">id</span> <span class="stringliteral">&#39;jacoco&#39;</span>       <span class="comment">// Instrument build &amp; add coverage reporting tasks</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">codenarcMain {</div>
<div class="line">  configFile = file(<span class="stringliteral">&quot;$rootDir/config/codenarc/codenarc.groovy&quot;</span>)</div>
<div class="line">  ignoreFailures = true</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">codenarcTest {</div>
<div class="line">  configFile = file(<span class="stringliteral">&quot;$rootDir/config/codenarc/codenarc.groovy&quot;</span>)</div>
<div class="line"> </div>
<div class="line">  ignoreFailures = true</div>
<div class="line">}</div>
</div><!-- fragment --><p>That worked, but gave a stack of "compilation errors". These weren't real errors, just CodeNarc getting confused. The code compiled and tested fine, the CodeNarc report was generated as expected. But these annoying error messages were on the console:</p>
<div class="fragment"><div class="line">...</div>
<div class="line">None: 22: unable to resolve class ShootLocation</div>
<div class="line"> @ line 22, column 13.</div>
<div class="line">     void add( ShootLocation sl ) {</div>
<div class="line">               ^</div>
<div class="line">...</div>
<div class="line">None: 5: unable to resolve class groovy.transform.Canonical</div>
<div class="line"> @ line 5, column 1.</div>
<div class="line">   import groovy.transform.Canonical</div>
<div class="line">   ^</div>
<div class="line">...</div>
</div><!-- fragment --><p>Some of the <a href="www.codenarc.org">CodeNarc</a> rules were causing these messages. I identified the failures by disabling rules until the error disappeared. This is very quick with <a href="https://www.codelord.net/2012/04/10/using-binary-search-for-debugging/">binary search debugging</a>. I found the <code>enhanced.xml</code> section was the source of the problem.</p>
<div class="fragment"><div class="line"><span class="comment">// rulesets/enhanced.xml &lt;-- Breaks CodeNarc 1.4</span></div>
<div class="line"><span class="comment">// CloneWithoutCloneable</span></div>
<div class="line"><span class="comment">// JUnitAssertEqualsConstantActualValue</span></div>
<div class="line"><span class="comment">// MissingOverrideAnnotation</span></div>
<div class="line"><span class="comment">// UnsafeImplementationAsMap</span></div>
</div><!-- fragment --><p>I had to disable all four tests to eliminate the spurious error messages. I need to revisit this, probably by grabbing the latest example RuleSet from the CodeNarc web site and <a href="https://www.computer.org/csdl/magazine/so/2013/05/mso2013050019/13rRUx0xPGJ">diff debugging</a>.</p>
<h2><a class="anchor" id="autotoc_md309"></a>
Logging</h2>
<p>Apache <a href="https://logging.apache.org/log4j/2.x/">Log4J2</a> is my preferred logging mechanism. Groovy has built-in annotation support for various loggers, making Log4J very easy to use. Groovy also removes the need for explicitly checking the log level.</p>
<div class="fragment"><div class="line">@groovy.util.logging.Log4j2(<span class="stringliteral">&#39;logger&#39;</span>)</div>
<div class="line"><span class="keyword">class </span>PhotoShoot {</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// ...</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> exportScript() {</div>
<div class="line">    logger.info <span class="keyword">this</span></div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line">  }</div>
</div><!-- fragment --><p> 
<a class='btn' href='wip20200719.html'>19-JUL-2020 ðŸ‘ˆ</a>
<a class='btn' href='#h20200720'>Top of page</a>
<!-- <a class='btn' href='wip20200721.html'>ðŸ‘‰ 21-JUL-2020</a> -->
<!-- <a class='btn' href='index.html'>ðŸ‘‰ 21-JUL-2020</a> -->
</p>
<p><span class="copyright">&copy; 2020 <a href="AboutMe.html" title="Terry Ebdon">Terry Ebdon.</a></span><br  />
<p>Find me coding on <a title="terry_ebdon on BitBucket"
href="https://github.com/TerryEbdon">GitHub,</a> networking on <a
title="Terry Ebdon on LinkedIn"
href="https://www.linkedin.com/in/talent/">LinkedIn</a> and hanging out on <a
title="@terry_ebdon" href="https://twitter.com/@terry_ebdon">twitter.</a> </p>
 </div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Jul 20 2020 15:44:08 for Developer&#39;s Diary by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.18 </li>
  </ul>
</div>
</body>
</html>
